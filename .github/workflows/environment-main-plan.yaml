name: Environment Main - Plan

on:
  pull_request: {}

permissions:
  id-token: write
  contents: read
  pull-requests: write

jobs:
  envtest:
    name: Environment Main - Plan
    runs-on: ubuntu-latest
    environment: main
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
    - name: Checkout code
      uses: actions/checkout@9a9194f87191a7e9055e3e9b95b8cfb13023bb08
    - name: Configure AWS Access
      uses: aws-actions/configure-aws-credentials@39228ca2bffc0bfc8f7761ce893f5b80e7eaaf8f
      with:
        role-to-assume: arn:aws:iam::${{ vars.AWS_ACCOUNT }}:role/GitHubAction-Wildsea
        role-session-name: GitHubTest
        aws-region: ${{ vars.AWS_REGION }}
    - name: terraform plan
      uses: dflook/terraform-apply@v1.44.0
      with:
        path: terraform/environment/github
        variables: |
          aws_account="${{ vars.AWS_ACCOUNT }}"
          aws_region="${{ vars.AWS_REGION }}"
          state_bucket="${{ vars.STATE_BUCKET }}"
          environment="${{ vars.ENVIRONMENT }}"
        backend_config:
          bucket=${{ vars.STATE_BUCKET }}
          key=${{ vars.ENVIRONMENT }}/terraform.tfstate
          region=${{ vars.AWS_REGION }}
